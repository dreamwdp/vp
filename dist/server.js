!function(e){var o={};function n(t){if(o[t])return o[t].exports;var r=o[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=o,n.d=function(e,o,t){n.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:t})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,o){if(1&o&&(e=n(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(n.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var r in e)n.d(t,r,function(o){return e[o]}.bind(null,r));return t},n.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(o,"a",o),o},n.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},n.p="/",n(n.s=11)}([function(e,o){e.exports=require("mysql")},function(e,o){e.exports=require("lodash.get")},function(e,o){e.exports=require("path")},function(e,o){e.exports=require("express")},function(e,o){e.exports=require("body-parser")},function(e,o){e.exports=require("axios")},function(e,o){e.exports=require("uuid")},function(e,o){e.exports=require("cookie-parser")},function(e,o){e.exports=require("cookie-session")},function(e,o){e.exports=require("csurf")},function(e,o){e.exports=require("helmet")},function(e,o,n){e.exports=n(12)},function(e,o,n){"use strict";n.r(o);var t=n(3),r=n.n(t),s=n(4),i=n.n(s),c=n(7),a=n.n(c),u=n(8),l=n.n(u),p=n(9),d=n.n(p),f=n(10),h=n.n(f),b=process.env,m=b.oauthRedirectDomin,E=b.fbAppSecret,k=b.fbAppKey,g=b.PORT,j="https://graph.facebook.com/v3.3",_=b.sessionSecret||"bigAndHUgeSecret",v="".concat(m,"/auth/fb"),y=n(5),L=n.n(y),O=function(e,o,n){try{e.session.app.isAuth?n():n(401)}catch(e){n(401)}},A=function(e,o,n){try{e.session.app.dbInfo.isAdmin?n():n(403)}catch(e){n(403)}},S=n(0),R=n.n(S),I=n(6),T=n.n(I),U=n(1),x=n.n(U),N=process.env,D=R.a.createPool({connectionLimit:4,multipleStatements:!1,host:N.SQL_HOST,port:N.SQL_PORT,user:N.SQL_USERNAME,password:N.SQL_PASSWORD,database:N.SQL_DATABASE}),W=function(e){return new Promise(function(o,n){D.query(e,function(e,t,r){e?(console.error(e),n(e)):o(t)})})},F=function(e){return{error:!1,result:e}},P=function(e){return{error:!0,result:e}},w={createFacebookLink:function(e){return"https://www.facebook.com/v2.8/dialog/oauth?client_id=".concat(k,"&response_type=code&state=").concat(e,"&redirect_uri=").concat(v)},checkUserInfo:function(e,o){var n="SELECT * FROM colorpk_user WHERE oauth = '".concat(e,"' AND oauthid = ").concat(Object(S.escape)(o));return W(n)},createNewUser:function(e,o,n){var t="INSERT INTO colorpk_user (oauth, name, oauthid, lastlogin) VALUES ('".concat(e,"', '").concat(o,"', '").concat(n,"', NOW())");return W(t)},addUserLike:function(e,o){var n="INSERT INTO colorpk_userlike (user_id, color_id) VALUES (".concat(Object(S.escape)(e),", ").concat(Object(S.escape)(o),")");return W(n)},removeUserLike:function(e,o){var n="DELETE FROM colorpk_userlike WHERE user_id= ".concat(e," AND color_id = ").concat(Object(S.escape)(o));return W(n)},getUserLike:function(e){var o="SELECT color_id FROM colorpk_userlike WHERE user_id= ".concat(Object(S.escape)(e));return W(o)},updateUserLoginDate:function(e){var o="UPDATE colorpk_user SET lastlogin=NOW() WHERE id=".concat(Object(S.escape)(e));return W(o)},convertOauthIntoLocalDB:function(e,o,n,t){var r=[],s=null,i=null;switch(e){case"wb":s=n.profile_image_url,i=n.name;break;case"fb":s=n.picture.data.url,i=n.name;break;case"gg":s=n.image.url,i=n.displayName}w.checkUserInfo(e,n.id).then(function(c){c.length<1?w.createNewUser(e,i,n.id).then(function(e){o.app.dbInfo={id:e.insertId,name:i,isAdmin:!1},t.json({isAuth:!0,like:r,profile:{id:n.id,name:i,img:s,isAdmin:!1}})},function(){console.error("create user error")}):(o.app.dbInfo={id:c[0].id,name:i,isAdmin:c[0].isadmin||!1},w.updateUserLoginDate(c[0].id),w.getUserLike(c[0].id).then(function(e){r=e.map(function(e){return e.color_id}),t.json({isAuth:!0,like:r,profile:{id:c[0].id,name:i,img:s,isAdmin:o.app.dbInfo.isAdmin}})}))})}},M=r.a.Router();M.post("/getUserInfo",function(e,o,n){if(x()(e,"session.app.isAuth",!1)){console.log("already signing in...");var t={access_token:e.session.app.tokenInfo.access_token,fields:"id,name,picture"};if(!t)return void console.error("session set error on authed users.");(s=t,L()({baseURL:j,method:"get",url:"/me",params:s})).then(function(n){w.convertOauthIntoLocalDB(e.session.app.oauth,e.session,n.data,o)},function(){o.json({isAuth:!1})})}else{var r=T.a.v1();e.session.app={isAuth:!1,oauthState:r},o.json({isAuth:!1})}var s}),M.post("/getInitAuth",function(e,o,n){if(x()(e,"session.app.isAuth",!1))o.json({isAuth:!0});else{var t=T.a.v1(),r={isAuth:!1,facebookUrl:w.createFacebookLink(t)};x()(e,"session.app.alert",null)&&(r.alert=e.session.app.alert),e.session.app={isAuth:!1,oauthState:t},o.json(r)}}),M.post("/logoff",function(e,o,n){console.log("logoff and delete session"),delete e.session.app,o.json({error:!1})}),M.post("/initColorList",function(e,o,n){W("SELECT a.* FROM colorpk_color a WHERE a.display=0 ORDER BY `id` DESC").then(function(e){o.json(F(e))},function(e){o.json(P(e))})}),M.post("/initColorPortfolio",O,function(e,o,n){var t=Object(S.escape)(e.session.app.dbInfo.id),r="SELECT a.*, false as `liked` FROM colorpk_color a WHERE userid = ".concat(t," ");W(r).then(function(e){o.json(F(e))},function(e){o.json(P(e))})}),M.post("/initColorLike",O,function(e,o,n){var t=Object(S.escape)(e.session.app.dbInfo.id),r="SELECT a.color_id FROM colorpk_userlike a WHERE a.user_id = ".concat(t," ");W(r).then(function(e){if(e.length<1)o.json(F([]));else{var n=e.map(function(e){return e.color_id}),t="SELECT a.*, false as `liked` FROM colorpk_color a WHERE a.id IN (".concat(n.join(","),")");W(t).then(function(e){o.json(F(e))},function(e){o.json(P(e))})}},function(e){o.json(P(e))})}),M.post("/toggleLike",function(e,o,n){var t="UPDATE colorpk_color SET `like` = `like` ".concat(e.body.willLike?"+":"-","  1 WHERE id = ").concat(Object(S.escape)(e.body.id));W(t).then(function(){o.json(F(1))},function(){o.json(P(0))}),x()(e,"session.app.isAuth",!1)&&(e.body.willLike?w.addUserLike(e.session.app.dbInfo.id,e.body.id):w.removeUserLike(e.session.app.dbInfo.id,e.body.id))}),M.post("/addNewColor",function(e,o,n){var t=x()(e,"session.app.isAuth",!1),r=x()(e,"session.app.dbInfo.name",null),s=x()(e,"session.app.dbInfo.id",null),i=t&&r?"'".concat(r,"'"):"NULL",c=t&&s?"".concat(s):"NULL",a="NULL"==c?1:0,u=(10*Math.random()).toFixed(),l=e.body.color;if(27===l.length){var p="INSERT INTO colorpk_color (`like`, color, userid, username, colortype, display, createdate) VALUES (".concat(u,", '").concat(l,"', ").concat(c,", ").concat(i,", NULL, ").concat(a,", NOW())");W(p).then(function(n){o.json(F({id:n.insertId,name:t?e.session.app.dbInfo.name:null}))},function(e){o.json(P(e))})}else o.json(P("invalid json"))}),M.post("/getAnonymousColor",O,A,function(e,o){W("SELECT * FROM colorpk_color a WHERE a.display = 1").then(function(e){o.json(F(e))},function(e){o.json(P(e))})}),M.post("/postDecideColor",O,A,function(e,o){var n=e.body,t=n.display,r=n.id,s=null;"number"==typeof r?(s=t?"DELETE FROM colorpk_color WHERE id = '".concat(r,"'"):"UPDATE colorpk_color SET `display` = 0 WHERE id = ".concat(Object(S.escape)(r)),W(s).then(function(e){o.json(F(e))},function(e){o.json(P(e))})):o.json({error:!0})});var q=M,C=n(2),H=n.n(C),Q=["","portfolio","popular","latest","like","color","new","adminpanel"],B=process.env.PWD,V=process.env.PWD,K=r()();K.set("x-powered-by",!1),K.use(h()()),K.use(i.a.json()),K.use(i.a.urlencoded({extended:!1})),K.use(a()()),K.use(l()({name:"session",keys:[_],domain:"react.colorpk.com",maxAge:2592e5,httpOnly:!0})),K.use(d()()),K.use("/api",q),K.get("/auth/:oauth",function(e,o){var n,t=e.query,r=e.params.oauth;if(t.code&&t.state&&e.session.app&&t.state===e.session.app.oauthState){console.log("redirected by ".concat(r," auth..."));var s=function(e,o){var n=o.code;return{client_id:k,client_secret:E,code:n,redirect_uri:v}}(0,t);(n=s,L()({baseURL:j,method:"get",url:"/oauth/access_token",params:n})).then(function(n){(n=n.data).access_token&&(e.session.app={oauth:r,isAuth:!0,tokenInfo:n}),o.redirect("/")})}else console.log("inconsistant session, error msg in session"),e.session.app={isAuth:!1,alert:{type:0,detail:"Sorry, something error, please try again."}},o.redirect("/")}),K.get("/*",function(e,o,n){var t=e.url.split("/");if(Q.indexOf(t[1])>-1){o.cookie("_csrf",e.csrfToken());var r=H.a.join(B,"./".concat("dist","/public/index.html"));o.sendFile(r)}else n()}),K.use(function(e,o,n,t){403===e?(console.error("=====  Deny Admin  ====="),n.status(403).json(403)):404===e?(console.error("=====  Auth Failed  ====="),n.status(404).json(404)):(console.error("=====  Internal Error  ====="),console.error(e),n.status(500).json(500))}),K.use(function(e,o,n){console.error("NOT FOUND! url: ",e.url),o.status(404).sendFile(H.a.resolve(V,"./dist/public/404.html"))}),K.listen(g,"localhost",function(){console.log("".concat("prod"," is running: http://").concat("localhost",":").concat(g))}).timeout=6e4}]);