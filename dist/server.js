!function(n){var t={};function r(o){if(t[o])return t[o].exports;var e=t[o]={i:o,l:!1,exports:{}};return n[o].call(e.exports,e,e.exports,r),e.l=!0,e.exports}r.m=n,r.c=t,r.d=function(o,e,n){r.o(o,e)||Object.defineProperty(o,e,{enumerable:!0,get:n})},r.r=function(o){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})},r.t=function(e,o){if(1&o&&(e=r(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var t in e)r.d(n,t,function(o){return e[o]}.bind(null,t));return n},r.n=function(o){var e=o&&o.__esModule?function(){return o.default}:function(){return o};return r.d(e,"a",e),e},r.o=function(o,e){return Object.prototype.hasOwnProperty.call(o,e)},r.p="/",r(r.s=13)}([function(o,e,n){"use strict";n.d(e,"c",function(){return i}),n.d(e,"b",function(){return c}),n.d(e,"g",function(){return s}),n.d(e,"d",function(){return a}),n.d(e,"a",function(){return u}),n.d(e,"f",function(){return l}),n.d(e,"h",function(){return d}),n.d(e,"e",function(){return f}),n.d(e,"i",function(){return p});var t=process.env,r=t.oauthRedirectDomin,i=t.fbAppSecret,c=t.fbAppKey,s=t.PORT,a=!1,u="https://graph.facebook.com/v3.3",l="localhost",d=t.sessionSecret||"bigAndHUgeSecret",f="".concat(a?"http://localhost:".concat(s):r,"/api/login/fb"),p=a?"local":"dist"},function(o,e,n){"use strict";n.d(e,"b",function(){return t}),n.d(e,"a",function(){return r});var t=function(o){return{error:!1,result:o}},r=function(o){return{error:!0,result:o}}},function(o,e,n){"use strict";n.d(e,"a",function(){return s});var t=n(3),r=n.n(t),i=process.env,c=r.a.createPool({connectionLimit:8,multipleStatements:!1,host:i.SQL_HOST,port:i.SQL_PORT,user:i.SQL_USERNAME,password:i.SQL_PASSWORD,database:i.SQL_DATABASE}),s=function(o){return new Promise(function(t,r){c.query(o,function(o,e,n){o?(console.error(o),r(o)):t(e)})})}},function(o,e){o.exports=require("mysql")},function(o,e){o.exports=require("path")},function(o,e){o.exports=require("express")},function(o,e){o.exports=require("body-parser")},function(o,e){o.exports=require("uuid")},function(o,e){o.exports=require("axios")},function(o,e){o.exports=require("cookie-parser")},function(o,e){o.exports=require("cookie-session")},function(o,e){o.exports=require("csurf")},function(o,e){o.exports=require("helmet")},function(o,e,n){o.exports=n(16)},function(o,e,n){"use strict";n.r(e),n.d(e,"isAuth",function(){return t}),n.d(e,"isAdmin",function(){return r});var t=function(o,e,n){try{o.session.app.isAuth?n():n(401)}catch(o){n(401)}},r=function(o,e,n){try{o.session.app.dbInfo.isAdmin?n():n(403)}catch(o){n(403)}}},function(o,e,n){"use strict";n.r(e),n.d(e,"getAnonymousColor",function(){return t}),n.d(e,"postDecideColor",function(){return r});var c=n(2),s=n(1),t=function(o,e,n){Object(c.a)("SELECT * FROM colorpk_color a WHERE a.display = 1").then(function(o){e.json(Object(s.b)(o))},function(o){e.json(Object(s.a)(o))})},r=function(o,e,n){var t=o.body.display,r=o.body.id,i=null;"number"==typeof r?(i=t?"DELETE FROM colorpk_color WHERE id = '".concat(r,"'"):"UPDATE colorpk_color SET `display` = 0 WHERE id = ".concat(r),Object(c.a)(i).then(function(o){e.json(Object(s.b)(o))},function(o){e.json(Object(s.a)(o))})):e.json({error:!0})}},function(o,e,n){"use strict";n.r(e);var t=n(5),r=n.n(t),i=n(6),c=n.n(i),s=n(9),a=n.n(s),u=n(10),l=n.n(u),d=n(11),f=n.n(d),p=n(12),b=n.n(p),h=n(5).Router(),j=n(14),m=n(17),g=n(15);h.get("/login/:oauth",m.oauthLogin),h.post("/getUserInfo",m.getUserInfo),h.post("/getInitAuth",m.getInitAuth),h.post("/logoff",m.logoff),h.post("/initColorList",m.initColorList),h.post("/initColorPortfolio",j.isAuth,m.initColorPortfolio),h.post("/initColorLike",j.isAuth,m.initColorLike),h.post("/getColorType",m.getColorType),h.post("/toggleLike",m.toggleLike),h.post("/addNewColor",m.addNewColor),h.post("/getAnonymousColor",j.isAuth,j.isAdmin,g.getAnonymousColor),h.post("/postDecideColor",j.isAuth,j.isAdmin,g.postDecideColor);var O=h,k=n(4),E=n.n(k),y=n(0),A=["","portfolio","popular","latest","like","color","new","adminpanel"],v=["main.js","main.css","newColor.js","newColor.css","adminPanel.js","adminPanel.css"],L=process.env.PWD,_=process.env.PWD,S=r()();S.set("x-powered-by",!1),S.use(b()()),S.use(c.a.json()),S.use(c.a.urlencoded({extended:!1})),S.use(a()()),S.use(l()({name:"session",keys:[y.h],domain:y.d?"localhost":"react.colorpk.com",maxAge:2592e5,httpOnly:!0,secure:!y.d})),S.use(f()()),y.d&&S.get("/static/:fileName",function(o,e,n){var t=o.params.fileName,r=E.a.resolve(L,"./".concat(y.i,"/public/").concat(t));v.includes(t)?e.sendFile(r):n()}),S.use("/api",O),S.get("/*",function(o,e,n){var t=o.url.split("/");if(-1<A.indexOf(t[1])){y.d&&console.log("".concat(o.method,": ").concat(o.originalUrl)),e.cookie("_csrf",o.csrfToken());var r=E.a.join(L,"./".concat(y.i,"/public/index.html"));e.sendFile(r)}else n()}),S.use(function(o,e,n,t){403===o?(console.error("=====  Deny Admin  ====="),n.status(403).json(403)):404===o?(console.error("=====  Auth Failed  ====="),n.status(404).json(404)):(console.error("=====  Internal Error  ====="),console.error(o),n.status(500).json(500))}),S.use(function(o,e,n){console.error("NOT FOUND! url: ",o.url),e.status(404).sendFile(E.a.resolve(_,"./dist/public/404.html"))}),S.listen(y.g,y.f,function(){console.log("".concat("production"," is running: http://").concat(y.f,":").concat(y.g))}).timeout=6e4},function(o,e,n){"use strict";n.r(e);var t=n(3),r=n(7),c=n.n(r),u=n(2),l=n(1),i=n(0),s=n(8),a=n.n(s);n.d(e,"getInitAuth",function(){return f}),n.d(e,"getUserInfo",function(){return p}),n.d(e,"oauthLogin",function(){return b}),n.d(e,"logoff",function(){return h}),n.d(e,"initColorList",function(){return j}),n.d(e,"initColorPortfolio",function(){return m}),n.d(e,"initColorLike",function(){return g}),n.d(e,"getColorType",function(){return O}),n.d(e,"toggleLike",function(){return k}),n.d(e,"addNewColor",function(){return E});var d={createFacebookLink:function(o){return"https://www.facebook.com/v2.8/dialog/oauth?client_id="+i.b+"&response_type=code&state="+o+"&redirect_uri="+i.e},getOauthQsObj:function(o,e){return{client_id:i.b,client_secret:i.c,code:e.code,redirect_uri:i.e}},checkUserInfo:function(o,e){var n="SELECT * FROM colorpk_user WHERE oauth = '".concat(o,"' AND oauthid = ").concat(e);return Object(u.a)(n)},createNewUser:function(o,e,n){var t="INSERT INTO colorpk_user (oauth, name, oauthid, lastlogin) VALUES ('".concat(o,"', '").concat(e,"', '").concat(n,"', NOW())");return Object(u.a)(t)},addUserLike:function(o,e){var n="INSERT INTO colorpk_userlike (user_id, color_id) VALUES ('".concat(o,"', '").concat(Object(t.escape)(e),"')");return Object(u.a)(n)},removeUserLike:function(o,e){var n="DELETE FROM colorpk_userlike WHERE user_id= '".concat(o,"' AND color_id = '").concat(Object(t.escape)(e),"'");return Object(u.a)(n)},getUserLike:function(o){var e="SELECT color_id FROM colorpk_userlike WHERE user_id= '".concat(o,"'");return Object(u.a)(e)},updateUserLoginDate:function(o){var e="UPDATE colorpk_user SET lastlogin=NOW() WHERE id=".concat(o);return Object(u.a)(e)},convertOauthIntoLocalDB:function(o,n,t,r){var i=[],c=null,s=null;switch(o){case"wb":c=t.profile_image_url,s=t.name;break;case"fb":c=t.picture.data.url,s=t.name;break;case"gg":c=t.image.url,s=t.displayName}d.checkUserInfo(o,t.id).then(function(e){e.length<1?d.createNewUser(o,s,t.id).then(function(o){n.app.dbInfo={id:o.insertId,name:s,isAdmin:!1},r.json({isAuth:!0,like:i,profile:{id:t.id,name:s,img:c,isAdmin:!1}})},function(){console.error("create user error")}):(n.app.dbInfo={id:e[0].id,name:s,isAdmin:e[0].isadmin||!1},d.updateUserLoginDate(e[0].id),d.getUserLike(e[0].id).then(function(o){i=o.map(function(o){return o.color_id}),r.json({isAuth:!0,like:i,profile:{id:e[0].id,name:s,img:c,isAdmin:n.app.dbInfo.isAdmin}})}))})}},f=function(o,e,n){var t=o.session;if(t.app&&t.app.isAuth)e.json({isAuth:!0});else{var r=c.a.v1(),i={isAuth:!1,facebookUrl:d.createFacebookLink(r)};o.session.app&&o.session.app.alert&&(i.alert=o.session.app.alert),o.session.app={isAuth:!1,oauthState:r},e.json(i)}},p=function(o,e,n){var t=o.session;if(t.app&&t.app.isAuth){console.log("already signing in..."),function(o){return a()({baseURL:i.a,method:"get",url:"/me",params:o})}({access_token:t.app.tokenInfo.access_token,fields:"id,name,picture"}).then(function(o){d.convertOauthIntoLocalDB(t.app.oauth,t,o.data,e)},function(){e.json({isAuth:!1})})}else{var r=c.a.v1();o.session.app={isAuth:!1,oauthState:r},e.json({isAuth:!1})}},b=function(e,n){var o=e.query,t=e.params.oauth;o.code&&o.state&&e.session.app&&o.state===e.session.app.oauthState?(console.log("redirected by ".concat(t," auth...")),function(o){return a()({baseURL:i.a,method:"get",url:"/oauth/access_token",params:o})}(d.getOauthQsObj(t,o)).then(function(o){(o=o.data).access_token&&(e.session.app={oauth:t,isAuth:!0,tokenInfo:o}),n.redirect("/")})):(console.log("inconsistant session, error msg in session"),e.session.app={isAuth:!1,alert:{type:0,detail:"Sorry, something error, please try again."}},n.redirect("/"))},h=function(o,e,n){console.log("logoff and delete session"),delete o.session.app,e.json({error:!1})},j=function(o,e,n){Object(u.a)("SELECT a.* FROM colorpk_color a WHERE a.display=0 ORDER BY `id` DESC").then(function(o){e.json(Object(l.b)(o))},function(o){e.json(Object(l.a)(o))})},m=function(o,e,n){var t="SELECT a.*, false as `liked` FROM colorpk_color a WHERE userid = '".concat(o.session.app.dbInfo.id,"' ");Object(u.a)(t).then(function(o){e.json(Object(l.b)(o))},function(o){e.json(Object(l.a)(o))})},g=function(o,t,e){var n="SELECT a.color_id FROM colorpk_userlike a WHERE a.user_id = '".concat(o.session.app.dbInfo.id,"' ");Object(u.a)(n).then(function(o){if(o.length<1)t.json(Object(l.b)([]));else{var e=o.map(function(o,e){return o.color_id}),n="SELECT a.*, false as `liked` FROM colorpk_color a WHERE a.id IN (".concat(e.join(","),") ");Object(u.a)(n).then(function(o){t.json(Object(l.b)(o))},function(o){t.json(Object(l.a)(o))})}},function(o){t.json(Object(l.a)(o))})},O=function(o,e,n){Object(u.a)("SELECT a.id AS `key`, a.name AS `value` FROM colorpk_colortype a").then(function(o){e.json(Object(l.b)(o))},function(o){e.json(Object(l.a)(o))})},k=function(o,e,n){var t="UPDATE colorpk_color SET `like` = `like` ".concat(o.body.willLike?"+":"-","  1 WHERE id = ").concat(o.body.id);Object(u.a)(t).then(function(){e.json(Object(l.b)(1))},function(){e.json(Object(l.a)(0))}),o.session.app&&o.session.app.isAuth&&(o.body.willLike?d.addUserLike(o.session.app.dbInfo.id,o.body.id):d.removeUserLike(o.session.app.dbInfo.id,o.body.id))},E=function(e,n,o){var t=e.session.app&&e.session.app.isAuth,r=t&&e.session.app.dbInfo.name?"'".concat(e.session.app.dbInfo.name,"'"):"NULL",i=t&&e.session.app.dbInfo.id?"".concat(e.session.app.dbInfo.id):"NULL",c="NULL"==i?1:0,s=(10*Math.random()).toFixed();if(27===e.body.color.length){var a="INSERT INTO colorpk_color (`like`, color, userid, username, colortype, display, createdate) VALUES (".concat(s,", '").concat(e.body.color,"', ").concat(i,", ").concat(r,", '").concat(e.body.colorType,"', ").concat(c,", NOW())");Object(u.a)(a).then(function(o){n.json(Object(l.b)({id:o.insertId,name:t?e.session.app.dbInfo.name:null}))},function(o){n.json(Object(l.a)(o))})}else n.json(Object(l.a)("invalid json"))}}]);