!function(n){var t={};function r(e){if(t[e])return t[e].exports;var o=t[e]={i:e,l:!1,exports:{}};return n[e].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=n,r.c=t,r.d=function(e,o,n){r.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(o,e){if(1&e&&(o=r(o)),8&e)return o;if(4&e&&"object"==typeof o&&o&&o.__esModule)return o;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:o}),2&e&&"string"!=typeof o)for(var t in o)r.d(n,t,function(e){return o[e]}.bind(null,t));return n},r.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(o,"a",o),o},r.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},r.p="/",r(r.s=11)}([function(e,o){e.exports=require("mysql")},function(e,o){e.exports=require("lodash.get")},function(e,o){e.exports=require("path")},function(e,o){e.exports=require("express")},function(e,o){e.exports=require("body-parser")},function(e,o){e.exports=require("axios")},function(e,o){e.exports=require("uuid")},function(e,o){e.exports=require("cookie-parser")},function(e,o){e.exports=require("cookie-session")},function(e,o){e.exports=require("csurf")},function(e,o){e.exports=require("helmet")},function(e,o,n){e.exports=n(12)},function(e,o,n){"use strict";n.r(o);function t(e,o,n){try{e.session.app.isAuth?n():n(401)}catch(e){n(401)}}function r(e,o,n){try{e.session.app.dbInfo.isAdmin?n():n(403)}catch(e){n(403)}}function d(e){return new Promise(function(t,r){w.query(e,function(e,o,n){e?(console.error(e),r(e)):t(o)})})}function f(e){return{error:!1,result:e}}function h(e){return{error:!0,result:e}}var s=n(3),i=n.n(s),c=n(4),a=n.n(c),u=n(7),l=n.n(u),p=n(8),b=n.n(p),m=n(9),E=n.n(m),k=n(10),g=n.n(k),j=process.env,_=j.oauthRedirectDomin,y=j.fbAppSecret,L=j.fbAppKey,v=j.PORT,O="https://graph.facebook.com/v3.3",A="localhost",S=j.sessionSecret||"bigAndHUgeSecret",R="".concat(_,"/auth/fb"),I=n(5),T=n.n(I),U=n(0),x=n.n(U),N=n(6),D=n.n(N),W=n(1),F=n.n(W),P=process.env,w=x.a.createPool({connectionLimit:4,multipleStatements:!1,host:P.SQL_HOST,port:P.SQL_PORT,user:P.SQL_USERNAME,password:P.SQL_PASSWORD,database:P.SQL_DATABASE}),M={createFacebookLink:function(e){return"https://www.facebook.com/v2.8/dialog/oauth?client_id=".concat(L,"&response_type=code&state=").concat(e,"&redirect_uri=").concat(R)},checkUserInfo:function(e,o){var n="SELECT * FROM colorpk_user WHERE oauth = '".concat(e,"' AND oauthid = ").concat(Object(U.escape)(o));return d(n)},createNewUser:function(e,o,n){var t="INSERT INTO colorpk_user (oauth, name, oauthid, lastlogin) VALUES ('".concat(e,"', '").concat(o,"', '").concat(n,"', NOW())");return d(t)},addUserLike:function(e,o){var n="INSERT INTO colorpk_userlike (user_id, color_id) VALUES (".concat(Object(U.escape)(e),", ").concat(Object(U.escape)(o),")");return d(n)},removeUserLike:function(e,o){var n="DELETE FROM colorpk_userlike WHERE user_id= ".concat(e," AND color_id = ").concat(Object(U.escape)(o));return d(n)},getUserLike:function(e){var o="SELECT color_id FROM colorpk_userlike WHERE user_id= ".concat(Object(U.escape)(e));return d(o)},updateUserLoginDate:function(e){var o="UPDATE colorpk_user SET lastlogin=NOW() WHERE id=".concat(Object(U.escape)(e));return d(o)},convertOauthIntoLocalDB:function(e,n,t,r){var s=[],i=null,c=null;switch(e){case"wb":i=t.profile_image_url,c=t.name;break;case"fb":i=t.picture.data.url,c=t.name;break;case"gg":i=t.image.url,c=t.displayName}M.checkUserInfo(e,t.id).then(function(o){o.length<1?M.createNewUser(e,c,t.id).then(function(e){n.app.dbInfo={id:e.insertId,name:c,isAdmin:!1},r.json({isAuth:!0,like:s,profile:{id:t.id,name:c,img:i,isAdmin:!1}})},function(){console.error("create user error")}):(n.app.dbInfo={id:o[0].id,name:c,isAdmin:o[0].isadmin||!1},M.updateUserLoginDate(o[0].id),M.getUserLike(o[0].id).then(function(e){s=e.map(function(e){return e.color_id}),r.json({isAuth:!0,like:s,profile:{id:o[0].id,name:c,img:i,isAdmin:n.app.dbInfo.isAdmin}})}))})}},q=i.a.Router();q.post("/getUserInfo",function(o,n,e){if(F()(o,"session.app.isAuth",!1))console.log("already signing in..."),function(e){return T()({baseURL:O,method:"get",url:"/me",params:e})}({access_token:o.session.app.tokenInfo.access_token,fields:"id,name,picture"}).then(function(e){M.convertOauthIntoLocalDB(o.session.app.oauth,o.session,e.data,n)},function(){n.json({isAuth:!1})});else{var t=D.a.v1();o.session.app={isAuth:!1,oauthState:t},n.json({isAuth:!1})}}),q.post("/getInitAuth",function(e,o,n){if(F()(e,"session.app.isAuth",!1))o.json({isAuth:!0});else{var t=D.a.v1(),r={isAuth:!1,facebookUrl:M.createFacebookLink(t)};F()(e,"session.app.alert",null)&&(r.alert=e.session.app.alert),e.session.app={isAuth:!1,oauthState:t},o.json(r)}}),q.post("/logoff",function(e,o,n){console.log("logoff and delete session"),delete e.session.app,o.json({error:!1})}),q.post("/initColorList",function(e,o,n){d("SELECT a.* FROM colorpk_color a WHERE a.display=0 ORDER BY `id` DESC").then(function(e){o.json(f(e))},function(e){o.json(h(e))})}),q.post("/initColorPortfolio",t,function(e,o,n){var t=Object(U.escape)(e.session.app.dbInfo.id),r="SELECT a.*, false as `liked` FROM colorpk_color a WHERE userid = ".concat(t," ");d(r).then(function(e){o.json(f(e))},function(e){o.json(h(e))})}),q.post("/initColorLike",t,function(e,t,o){var n=Object(U.escape)(e.session.app.dbInfo.id),r="SELECT a.color_id FROM colorpk_userlike a WHERE a.user_id = ".concat(n," ");d(r).then(function(e){if(e.length<1)t.json(f([]));else{var o=e.map(function(e){return e.color_id}),n="SELECT a.*, false as `liked` FROM colorpk_color a WHERE a.id IN (".concat(o.join(","),")");d(n).then(function(e){t.json(f(e))},function(e){t.json(h(e))})}},function(e){t.json(h(e))})}),q.post("/toggleLike",function(e,o,n){var t="UPDATE colorpk_color SET `like` = `like` ".concat(e.body.willLike?"+":"-","  1 WHERE id = ").concat(Object(U.escape)(e.body.id));d(t).then(function(){o.json(f(1))},function(){o.json(h(0))}),F()(e,"session.app.isAuth",!1)&&(e.body.willLike?M.addUserLike(e.session.app.dbInfo.id,e.body.id):M.removeUserLike(e.session.app.dbInfo.id,e.body.id))}),q.post("/addNewColor",function(o,n,e){var t=F()(o,"session.app.isAuth",!1),r=F()(o,"session.app.dbInfo.name",null),s=F()(o,"session.app.dbInfo.id",null),i=t&&r?"'".concat(r,"'"):"NULL",c=t&&s?"".concat(s):"NULL",a="NULL"==c?1:0,u=(10*Math.random()).toFixed(),l=o.body.color;if(27===l.length){var p="INSERT INTO colorpk_color (`like`, color, userid, username, colortype, display, createdate) VALUES (".concat(u,", '").concat(l,"', ").concat(c,", ").concat(i,", NULL, ").concat(a,", NOW())");d(p).then(function(e){n.json(f({id:e.insertId,name:t?o.session.app.dbInfo.name:null}))},function(e){n.json(h(e))})}else n.json(h("invalid json"))}),q.post("/getAnonymousColor",t,r,function(e,o){d("SELECT * FROM colorpk_color a WHERE a.display = 1").then(function(e){o.json(f(e))},function(e){o.json(h(e))})}),q.post("/postDecideColor",t,r,function(e,o){var n=e.body,t=n.display,r=n.id,s=null;"number"==typeof r?(s=t?"DELETE FROM colorpk_color WHERE id = '".concat(r,"'"):"UPDATE colorpk_color SET `display` = 0 WHERE id = ".concat(Object(U.escape)(r)),d(s).then(function(e){o.json(f(e))},function(e){o.json(h(e))})):o.json({error:!0})});var C=q,H=n(2),Q=n.n(H),B=["","portfolio","popular","latest","like","color","new","adminpanel"],V=process.env.PWD,K=process.env.PWD,Y=i()();Y.set("x-powered-by",!1),Y.use(g()()),Y.use(a.a.json()),Y.use(a.a.urlencoded({extended:!1})),Y.use(l()()),Y.use(b()({name:"session",keys:[S],domain:"react.colorpk.com",maxAge:2592e5,httpOnly:!0})),Y.use(E()()),Y.use("/api",C),Y.get("/auth/:oauth",function(o,n){var e=o.query,t=o.params.oauth;e.code&&e.state&&o.session.app&&e.state===o.session.app.oauthState?(console.log("redirected by ".concat(t," auth...")),function(e){return T()({baseURL:O,method:"get",url:"/oauth/access_token",params:e})}(function(e,o){var n=o.code;return{client_id:L,client_secret:y,code:n,redirect_uri:R}}(0,e)).then(function(e){(e=e.data).access_token&&(o.session.app={oauth:t,isAuth:!0,tokenInfo:e}),n.redirect("/")})):(console.log("inconsistant session, error msg in session"),o.session.app={isAuth:!1,alert:{type:0,detail:"Sorry, something error, please try again."}},n.redirect("/"))}),Y.get("/*",function(e,o,n){var t=e.url.split("/");if(-1<B.indexOf(t[1])){o.cookie("_csrf",e.csrfToken());var r=Q.a.join(V,"./".concat("dist","/public/index.html"));o.sendFile(r)}else n()}),Y.use(function(e,o,n,t){403===e?(console.error("=====  Deny Admin  ====="),n.status(403).json(403)):404===e?(console.error("=====  Auth Failed  ====="),n.status(404).json(404)):(console.error("=====  Internal Error  ====="),console.error(e),n.status(500).json(500))}),Y.use(function(e,o,n){console.error("NOT FOUND! url: ",e.url),o.status(404).sendFile(Q.a.resolve(K,"./dist/public/404.html"))}),Y.listen(v,A,function(){console.log("".concat("prod"," is running: http://").concat(A,":").concat(v))}).timeout=6e4}]);