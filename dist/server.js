!function(n){var t={};function r(o){if(t[o])return t[o].exports;var e=t[o]={i:o,l:!1,exports:{}};return n[o].call(e.exports,e,e.exports,r),e.l=!0,e.exports}r.m=n,r.c=t,r.d=function(o,e,n){r.o(o,e)||Object.defineProperty(o,e,{enumerable:!0,get:n})},r.r=function(o){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})},r.t=function(e,o){if(1&o&&(e=r(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var t in e)r.d(n,t,function(o){return e[o]}.bind(null,t));return n},r.n=function(o){var e=o&&o.__esModule?function(){return o.default}:function(){return o};return r.d(e,"a",e),e},r.o=function(o,e){return Object.prototype.hasOwnProperty.call(o,e)},r.p="/",r(r.s=10)}([function(o,e){o.exports=require("mysql")},function(o,e){o.exports=require("path")},function(o,e){o.exports=require("express")},function(o,e){o.exports=require("body-parser")},function(o,e){o.exports=require("uuid")},function(o,e){o.exports=require("axios")},function(o,e){o.exports=require("cookie-parser")},function(o,e){o.exports=require("cookie-session")},function(o,e){o.exports=require("csurf")},function(o,e){o.exports=require("helmet")},function(o,e,n){o.exports=n(11)},function(o,e,n){"use strict";n.r(e);function t(o,e,n){try{o.session.app.isAuth?n():n(401)}catch(o){n(401)}}function r(o,e,n){try{o.session.app.dbInfo.isAdmin?n():n(403)}catch(o){n(403)}}function u(o){return new Promise(function(t,r){A.query(o,function(o,e,n){o?(console.error(o),r(o)):t(e)})})}function l(o){return{error:!1,result:o}}function p(o){return{error:!0,result:o}}var s=n(2),i=n.n(s),c=n(3),a=n.n(c),d=n(6),f=n.n(d),h=n(7),m=n.n(h),b=n(8),E=n.n(b),k=n(9),g=n.n(k),y=n(0),_=n.n(y),v=n(4),j=n.n(v),L=process.env,A=_.a.createPool({connectionLimit:8,multipleStatements:!1,host:L.SQL_HOST,port:L.SQL_PORT,user:L.SQL_USERNAME,password:L.SQL_PASSWORD,database:L.SQL_DATABASE}),S=process.env,O=S.oauthRedirectDomin,R=S.fbAppSecret,I=S.fbAppKey,T=S.PORT,U="https://graph.facebook.com/v3.3",x="localhost",N=S.sessionSecret||"bigAndHUgeSecret",D="".concat(O,"/api/login/fb"),W=n(5),F=n.n(W),P={createFacebookLink:function(o){return"https://www.facebook.com/v2.8/dialog/oauth?client_id="+I+"&response_type=code&state="+o+"&redirect_uri="+D},getOauthQsObj:function(o,e){return{client_id:I,client_secret:R,code:e.code,redirect_uri:D}},checkUserInfo:function(o,e){var n="SELECT * FROM colorpk_user WHERE oauth = '".concat(o,"' AND oauthid = ").concat(e);return u(n)},createNewUser:function(o,e,n){var t="INSERT INTO colorpk_user (oauth, name, oauthid, lastlogin) VALUES ('".concat(o,"', '").concat(e,"', '").concat(n,"', NOW())");return u(t)},addUserLike:function(o,e){var n="INSERT INTO colorpk_userlike (user_id, color_id) VALUES ('".concat(o,"', '").concat(Object(y.escape)(e),"')");return u(n)},removeUserLike:function(o,e){var n="DELETE FROM colorpk_userlike WHERE user_id= '".concat(o,"' AND color_id = '").concat(Object(y.escape)(e),"'");return u(n)},getUserLike:function(o){var e="SELECT color_id FROM colorpk_userlike WHERE user_id= '".concat(o,"'");return u(e)},updateUserLoginDate:function(o){var e="UPDATE colorpk_user SET lastlogin=NOW() WHERE id=".concat(o);return u(e)},convertOauthIntoLocalDB:function(o,n,t,r){var s=[],i=null,c=null;switch(o){case"wb":i=t.profile_image_url,c=t.name;break;case"fb":i=t.picture.data.url,c=t.name;break;case"gg":i=t.image.url,c=t.displayName}P.checkUserInfo(o,t.id).then(function(e){e.length<1?P.createNewUser(o,c,t.id).then(function(o){n.app.dbInfo={id:o.insertId,name:c,isAdmin:!1},r.json({isAuth:!0,like:s,profile:{id:t.id,name:c,img:i,isAdmin:!1}})},function(){console.error("create user error")}):(n.app.dbInfo={id:e[0].id,name:c,isAdmin:e[0].isadmin||!1},P.updateUserLoginDate(e[0].id),P.getUserLike(e[0].id).then(function(o){s=o.map(function(o){return o.color_id}),r.json({isAuth:!0,like:s,profile:{id:e[0].id,name:c,img:i,isAdmin:n.app.dbInfo.isAdmin}})}))})}},w=i.a.Router();w.get("/login/:oauth",function(e,n){var o=e.query,t=e.params.oauth;o.code&&o.state&&e.session.app&&o.state===e.session.app.oauthState?(console.log("redirected by ".concat(t," auth...")),function(o){return F()({baseURL:U,method:"get",url:"/oauth/access_token",params:o})}(P.getOauthQsObj(t,o)).then(function(o){(o=o.data).access_token&&(e.session.app={oauth:t,isAuth:!0,tokenInfo:o}),n.redirect("/")})):(console.log("inconsistant session, error msg in session"),e.session.app={isAuth:!1,alert:{type:0,detail:"Sorry, something error, please try again."}},n.redirect("/"))}),w.post("/getUserInfo",function(o,e,n){var t=o.session;if(t.app&&t.app.isAuth)console.log("already signing in..."),function(o){return F()({baseURL:U,method:"get",url:"/me",params:o})}({access_token:t.app.tokenInfo.access_token,fields:"id,name,picture"}).then(function(o){P.convertOauthIntoLocalDB(t.app.oauth,t,o.data,e)},function(){e.json({isAuth:!1})});else{var r=j.a.v1();o.session.app={isAuth:!1,oauthState:r},e.json({isAuth:!1})}}),w.post("/getInitAuth",function(o,e,n){var t=o.session;if(t.app&&t.app.isAuth)e.json({isAuth:!0});else{var r=j.a.v1(),s={isAuth:!1,facebookUrl:P.createFacebookLink(r)};o.session.app&&o.session.app.alert&&(s.alert=o.session.app.alert),o.session.app={isAuth:!1,oauthState:r},e.json(s)}}),w.post("/logoff",function(o,e,n){console.log("logoff and delete session"),delete o.session.app,e.json({error:!1})}),w.post("/initColorList",function(o,e,n){u("SELECT a.* FROM colorpk_color a WHERE a.display=0 ORDER BY `id` DESC").then(function(o){e.json(l(o))},function(o){e.json(p(o))})}),w.post("/initColorPortfolio",t,function(o,e,n){var t="SELECT a.*, false as `liked` FROM colorpk_color a WHERE userid = '".concat(o.session.app.dbInfo.id,"' ");u(t).then(function(o){e.json(l(o))},function(o){e.json(p(o))})}),w.post("/initColorLike",t,function(o,t,e){var n="SELECT a.color_id FROM colorpk_userlike a WHERE a.user_id = '".concat(o.session.app.dbInfo.id,"' ");u(n).then(function(o){if(o.length<1)t.json(l([]));else{var e=o.map(function(o,e){return o.color_id}),n="SELECT a.*, false as `liked` FROM colorpk_color a WHERE a.id IN (".concat(e.join(","),") ");u(n).then(function(o){t.json(l(o))},function(o){t.json(p(o))})}},function(o){t.json(p(o))})}),w.post("/toggleLike",function(o,e,n){var t="UPDATE colorpk_color SET `like` = `like` ".concat(o.body.willLike?"+":"-","  1 WHERE id = ").concat(o.body.id);u(t).then(function(){e.json(l(1))},function(){e.json(p(0))}),o.session.app&&o.session.app.isAuth&&(o.body.willLike?P.addUserLike(o.session.app.dbInfo.id,o.body.id):P.removeUserLike(o.session.app.dbInfo.id,o.body.id))}),w.post("/addNewColor",function(e,n,o){var t=e.session.app&&e.session.app.isAuth,r=t&&e.session.app.dbInfo.name?"'".concat(e.session.app.dbInfo.name,"'"):"NULL",s=t&&e.session.app.dbInfo.id?"".concat(e.session.app.dbInfo.id):"NULL",i="NULL"==s?1:0,c=(10*Math.random()).toFixed();if(27===e.body.color.length){var a="INSERT INTO colorpk_color (`like`, color, userid, username, colortype, display, createdate) VALUES (".concat(c,", '").concat(e.body.color,"', ").concat(s,", ").concat(r,", '").concat(e.body.colorType,"', ").concat(i,", NOW())");u(a).then(function(o){n.json(l({id:o.insertId,name:t?e.session.app.dbInfo.name:null}))},function(o){n.json(p(o))})}else n.json(p("invalid json"))}),w.post("/getAnonymousColor",t,r,function(o,e,n){u("SELECT * FROM colorpk_color a WHERE a.display = 1").then(function(o){e.json(l(o))},function(o){e.json(p(o))})}),w.post("/postDecideColor",t,r,function(o,e,n){var t=o.body.display,r=o.body.id,s=null;"number"==typeof r?(s=t?"DELETE FROM colorpk_color WHERE id = '".concat(r,"'"):"UPDATE colorpk_color SET `display` = 0 WHERE id = ".concat(r),u(s).then(function(o){e.json(l(o))},function(o){e.json(p(o))})):e.json({error:!0})});var M=w,C=n(1),H=n.n(C),q=["","portfolio","popular","latest","like","color","new","adminpanel"],Q=process.env.PWD,B=process.env.PWD,V=i()();V.set("x-powered-by",!1),V.use(g()()),V.use(a.a.json()),V.use(a.a.urlencoded({extended:!1})),V.use(f()()),V.use(m()({name:"session",keys:[N],domain:"react.colorpk.com",maxAge:2592e5,httpOnly:!0})),V.use(E()()),V.use("/api",M),V.get("/*",function(o,e,n){var t=o.url.split("/");if(-1<q.indexOf(t[1])){e.cookie("_csrf",o.csrfToken());var r=H.a.join(Q,"./".concat("dist","/public/index.html"));e.sendFile(r)}else n()}),V.use(function(o,e,n,t){403===o?(console.error("=====  Deny Admin  ====="),n.status(403).json(403)):404===o?(console.error("=====  Auth Failed  ====="),n.status(404).json(404)):(console.error("=====  Internal Error  ====="),console.error(o),n.status(500).json(500))}),V.use(function(o,e,n){console.error("NOT FOUND! url: ",o.url),e.status(404).sendFile(H.a.resolve(B,"./dist/public/404.html"))}),V.listen(T,x,function(){console.log("".concat("prod"," is running: http://").concat(x,":").concat(T))}).timeout=6e4}]);