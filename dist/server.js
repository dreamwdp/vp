!function(e){var r={};function n(t){if(r[t])return r[t].exports;var o=r[t]={i:t,l:!1,exports:{}};return e[t].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=r,n.d=function(e,r,t){n.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:t})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,r){if(1&r&&(e=n(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(n.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var o in e)n.d(t,o,function(r){return e[r]}.bind(null,o));return t},n.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(r,"a",r),r},n.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},n.p="/",n(n.s=13)}([function(e,r){e.exports=require("lodash.get")},function(e,r){e.exports=require("graphql")},function(e,r){e.exports=require("mysql")},function(e,r){e.exports=require("path")},function(e,r){e.exports=require("body-parser")},function(e,r){e.exports=require("axios")},function(e,r){e.exports=require("uuid")},function(e,r){e.exports=require("express")},function(e,r){e.exports=require("cookie-parser")},function(e,r){e.exports=require("cookie-session")},function(e,r){e.exports=require("csurf")},function(e,r){e.exports=require("helmet")},function(e,r){e.exports=require("express-graphql")},function(e,r,n){e.exports=n(15)},function(e,r){e.exports=require("regenerator-runtime/runtime")},function(e,r,n){"use strict";n.r(r);n(14);var t=n(7),o=n.n(t),a=n(4),u=n.n(a),c=n(8),s=n.n(c),i=n(9),p=n.n(i),l=n(10),d=n.n(l),f=n(0),E=n.n(f),h=process.env,b=h.SERVER_PORT,m=h.SESSION_SECRET,k=h.CSRF_EXCEPTION,y=h.FB_APP_KEY,g=h.FB_APP_SECRET,v=h.FB_REDIRECT_URL,S="https://graph.facebook.com/v3.3",O=d()(),_=function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];E()(r[0],"body._csrf",null)===k?(console.log("csrf exception"),r[2]()):O.apply(void 0,r)},L=n(11),R=n.n(L),x=n(5),I=n.n(x),T=function(e){return"https://www.facebook.com/v3.3/dialog/oauth?client_id=".concat(y,"&response_type=code&state=").concat(e,"&redirect_uri=").concat(v)},C=n(12),w=n.n(C),A=n(6),N=n.n(A),j=n(2),P=n.n(j),q=n(1),U=process.env,F=U.SQL_HOST,M=U.SQL_PORT,D=U.SQL_USERNAME,Q=U.SQL_PASSWORD,W=U.SQL_DATABASE,H=P.a.createPool({connectionLimit:4,multipleStatements:!1,host:F,port:M,user:D,password:Q,database:W}),B=function(e){return new Promise(function(r,n){H.query(e,function(e,t){e?(console.error(e),n(e)):r(t)})})},G=function(e,r){return Boolean(E()(e,"session.app.isAuth",!1)&&(r||E()(e,"session.app.dbInfo.id",null)))},V=function(e){var r=E()(e,"session.app.tokenInfo.access_token",null);return"string"==typeof r&&r.length>0},Y=function(e){return G(e)&&E()(e,"session.app.dbInfo.isAdmin",!1)};function K(e,r,n,t,o,a,u){try{var c=e[a](u),s=c.value}catch(e){return void n(e)}c.done?r(s):Promise.resolve(s).then(t,o)}function J(e){return function(){var r=this,n=arguments;return new Promise(function(t,o){var a=e.apply(r,n);function u(e){K(a,t,o,u,c,"next",e)}function c(e){K(a,t,o,u,c,"throw",e)}u(void 0)})}}var X={auth:function(){var e=J(regeneratorRuntime.mark(function e(r,n){var t,o,a,u,c,s,i,p,l,d,f,h,b,m,k,y,g,v,O;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!G(n,!0)||!V(n)){e.next=36;break}return t=E()(n,"session.app.tokenInfo.access_token",null),o={access_token:t,fields:"id,name,picture"},e.prev=3,e.next=6,r=o,I()({baseURL:S,method:"get",url:"/me",params:r});case 6:return a=e.sent,u=a.data,c=u.name,s=u.id,i="SELECT * FROM colorpk_user WHERE oauth = 'fb' AND oauthid = ".concat(Object(j.escape)(s)),e.next=12,B(i);case 12:if(1!==(p=e.sent).length){e.next=25;break}return l=p[0],d=l.isadmin,f=l.id,n.session.app.dbInfo={id:f,name:c,isAdmin:d||!1},h="SELECT color_id FROM colorpk_userlike WHERE user_id= ".concat(Object(j.escape)(f)),e.next=19,B(h);case 19:return b=e.sent,m="UPDATE colorpk_user SET lastlogin=NOW() WHERE id=".concat(Object(j.escape)(f)),B(m),e.abrupt("return",{user:{id:f,name:c,isadmin:d,img:E()(u,"picture.data.url",null),likes:b.map(function(e){return e.color_id})}});case 25:return k="INSERT INTO colorpk_user (oauth, name, oauthid, lastlogin) VALUES ('fb', '".concat(c,"', '").concat(g,"', NOW())"),y=B(k),g=y.insertId,n.session.app.dbInfo={id:g,name:c,isAdmin:!1},e.abrupt("return",{user:{id:g,name:c,isadmin:!1,img:E()(u,"picture.data.url",null),likes:[]}});case 29:e.next=34;break;case 31:return e.prev=31,e.t0=e.catch(3),e.abrupt("return",new q.GraphQLError(e.t0.toString()));case 34:e.next=41;break;case 36:return v=N.a.v1(),O={user:null,url:T(v)},E()(n,"session.app.authError",null)&&(O.authError=n.session.app.authError),n.session.app={oauthState:v},e.abrupt("return",O);case 41:case"end":return e.stop()}var r},e,null,[[3,31]])}));return function(r,n){return e.apply(this,arguments)}}(),color:function(){var e=J(regeneratorRuntime.mark(function e(r,n){var t,o,a,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.category,G(n)||!(["LIKES","PROFILE"].indexOf(t)>-1)){e.next=3;break}return e.abrupt("return",new q.GraphQLError("color error: no user defined"));case 3:if(Y(n)||"ANONYMOUS"!==t){e.next=5;break}return e.abrupt("return",new q.GraphQLError("color error: no admin access"));case 5:o=E()(n,"session.app.dbInfo.id",null),a=Object(j.escape)(o),u=null,e.t0=t,e.next="PUBLIC"===e.t0?11:"LIKES"===e.t0?13:"PROFILE"===e.t0?15:"ANONYMOUS"===e.t0?17:19;break;case 11:return u="SELECT a.* FROM colorpk_color a WHERE a.display=0 ORDER BY `id` DESC",e.abrupt("break",20);case 13:return u="SELECT a.* FROM colorpk_color a\n          INNER JOIN \n          (SELECT color_id FROM colorpk_userlike WHERE user_id = ".concat(a,") b\n          ON id = b.color_id"),e.abrupt("break",20);case 15:return u="SELECT a.*, false as `liked` FROM colorpk_color a WHERE userid = ".concat(a," "),e.abrupt("break",20);case 17:return u="SELECT * FROM colorpk_color a WHERE a.display = 1",e.abrupt("break",20);case 19:return e.abrupt("break",20);case 20:if(u){e.next=22;break}return e.abrupt("return",new q.GraphQLError("color error: unknown query"));case 22:return e.prev=22,e.next=25,B(u);case 25:return c=e.sent,e.abrupt("return",c.map(function(e){return{id:e.id,like:e.like,color:e.color,userid:e.userid,username:e.username,createdate:e.createdate}}));case 29:return e.prev=29,e.t1=e.catch(22),e.abrupt("return",new q.GraphQLError(e.t1.toString()));case 32:case"end":return e.stop()}},e,null,[[22,29]])}));return function(r,n){return e.apply(this,arguments)}}(),likeColor:function(){var e=J(regeneratorRuntime.mark(function e(r,n){var t,o,a,u,c,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.input,o=t.id,a=t.willLike,e.prev=1,G(n)&&(u=E()(n,"session.app.dbInfo.id",null),c=a?"INSERT INTO colorpk_userlike (user_id, color_id) VALUES (".concat(Object(j.escape)(u),", ").concat(Object(j.escape)(o),")"):"DELETE FROM colorpk_userlike WHERE user_id= ".concat(u," AND color_id = ").concat(Object(j.escape)(o)),B(c)),s="UPDATE colorpk_color SET `like` = `like` ".concat(a?"+":"-","  1 WHERE id = ").concat(Object(j.escape)(o)),e.next=6,B(s);case 6:return i=e.sent,e.abrupt("return",{status:1===i.affectedRows?0:1});case 10:return e.prev=10,e.t0=e.catch(1),e.abrupt("return",new q.GraphQLError(e.t0.toString()));case 13:case"end":return e.stop()}},e,null,[[1,10]])}));return function(r,n){return e.apply(this,arguments)}}(),createColor:function(){var e=J(regeneratorRuntime.mark(function e(r,n){var t,o,a,u,c,s,i,p,l,d;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.input.color,o=G(n),a=E()(n,"session.app.dbInfo.name",null),u=E()(n,"session.app.dbInfo.id",null),c=o&&a?"'".concat(a,"'"):"NULL",s=o&&u?"".concat(u):"NULL",i="NULL"==s?1:0,p=(10*Math.random()).toFixed(),27!==t.length){e.next=22;break}return l="INSERT INTO colorpk_color (`like`, color, userid, username, colortype, display, createdate) VALUES (".concat(p,", '").concat(t,"', ").concat(s,", ").concat(c,", NULL, ").concat(i,", NOW())"),e.prev=10,e.next=13,B(l);case 13:return d=e.sent,e.abrupt("return",{status:0,data:d.insertId});case 17:return e.prev=17,e.t0=e.catch(10),e.abrupt("return",new q.GraphQLError(e.t0.toString()));case 20:e.next=23;break;case 22:return e.abrupt("return",new q.GraphQLError("create error: invalid color input"));case 23:case"end":return e.stop()}},e,null,[[10,17]])}));return function(r,n){return e.apply(this,arguments)}}(),adjudicateColor:function(){var e=J(regeneratorRuntime.mark(function e(r,n){var t,o,a,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(Y(n)){e.next=2;break}return e.abrupt("return",new q.GraphQLError("adjudicate error: no admin access"));case 2:return t=r.input,o=t.id,a=t.willLike,u=a?"UPDATE colorpk_color SET `display` = 0 WHERE id = ".concat(Object(j.escape)(o)):"DELETE FROM colorpk_color WHERE id = '".concat(o,"'"),e.prev=4,e.next=7,B(u);case 7:return c=e.sent,e.abrupt("return",{status:1===c.affectedRows?0:1});case 11:return e.prev=11,e.t0=e.catch(4),e.abrupt("return",new q.GraphQLError(e.t0.toString()));case 14:case"end":return e.stop()}},e,null,[[4,11]])}));return function(r,n){return e.apply(this,arguments)}}(),logoff:function(e,r){var n=E()(r,"session.app.dbInfo.name","(unknow)");console.log("logoff ".concat(n,", delete session")),delete r.session.app;var t=N.a.v1();return r.session.app={oauthState:t},{url:T(t)}}},z=Object(q.buildSchema)("\n  enum ColorCategory {\n    PUBLIC\n    LIKES\n    PROFILE\n    ANONYMOUS\n  }\n\n  type Color {\n    id: ID!\n    like: Int!\n    color: String!\n    userid: Int\n    username: String\n    createdate: String\n  }\n\n  type User {\n    id: ID!\n    img: String\n    isadmin: Boolean\n    name: String\n    likes: [Int!]\n  }\n\n  input LikeColorInputType {\n    id: ID!\n    willLike: Boolean!\n  }\n  \n  input CreateColorInputType {\n    color: String!\n  }\n\n  type LikeColorOutputType {\n    status: Int!\n  }\n\n  type AdjudicateColorOutputType {\n    status: Int!\n  }\n\n  type CreateColorOutputType {\n    status: Int!\n    data: Int!\n  }\n\n  type AuthOutputType {\n    user: User\n    url: String\n    authError: String\n  }\n\n  type Mutation {\n    likeColor(input: LikeColorInputType!): LikeColorOutputType\n    createColor(input: CreateColorInputType!): CreateColorOutputType\n    adjudicateColor(input: LikeColorInputType!): AdjudicateColorOutputType\n    logoff: AuthOutputType\n  }\n  \n  type Query {\n    color(category: ColorCategory!): [Color]\n    auth: AuthOutputType\n  }\n\n  schema {\n    query: Query\n    mutation: Mutation\n  } \n"),Z=w()({schema:z,rootValue:X,graphiql:!1,pretty:!1}),$=n(3),ee=n.n($),re=["","portfolio","popular","latest","like","color","new","adminpanel"],ne=process.env.PWD,te=process.env.PWD,oe=o()();oe.set("x-powered-by",!1),oe.use(R()()),oe.use(u.a.json()),oe.use(u.a.urlencoded({extended:!1})),oe.use(s()()),oe.use(p()({name:"session",keys:[m],domain:"react.colorpk.com",maxAge:2592e5,httpOnly:!0})),oe.use(_),oe.use("/graphql",Z),oe.get("/auth/:oauth",function(e,r){var n,t=E()(e,"query.code",null),o=E()(e,"query.state",null),a=E()(e,"params.oauth",null),u=E()(e,"session.app.oauthState",null);if(t&&o&&o===u){console.log("redirected by ".concat(a," auth..."));var c=function(e,r){var n=r.code;return{client_id:y,client_secret:g,code:n,redirect_uri:v}}(0,e.query);(n=c,I()({baseURL:S,method:"get",url:"/oauth/access_token",params:n})).then(function(n){var t=n.data;t.access_token&&(e.session.app={oauth:a,isAuth:!0,tokenInfo:t}),r.redirect("/")})}else console.log("inconsistant session, error msg in session"),e.session.app={isAuth:!1,authError:"Sorry, something error, please try again."},r.redirect("/")}),oe.get("/*",function(e,r,n){var t=e.url.split("/");if(re.includes(t[1])){r.cookie("_csrf",e.csrfToken());var o=ee.a.join(ne,"./".concat("dist","/public/index.html"));r.sendFile(o)}else n()}),oe.use(function(e,r,n,t){403===e?(console.error("=====  Deny Admin  ====="),n.status(403).json(403)):404===e?(console.error("=====  Auth Failed  ====="),n.status(404).json(404)):(console.error("=====  Internal Error  ====="),console.error(e),n.status(500).json(500))}),oe.use(function(e,r,n){console.error("NOT FOUND! url: ",e.url),r.status(404).sendFile(ee.a.resolve(te,"./dist/public/404.html"))}),oe.listen(b,"localhost",function(){console.log("app(mode: ".concat("production",") is running: http://").concat("localhost",":").concat(b))}).timeout=5e3}]);