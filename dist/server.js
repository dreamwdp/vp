!function(e){var n={};function r(t){if(n[t])return n[t].exports;var o=n[t]={i:t,l:!1,exports:{}};return e[t].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=n,r.d=function(e,n,t){r.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,n){if(1&n&&(e=r(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(r.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)r.d(t,o,function(n){return e[n]}.bind(null,o));return t},r.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(n,"a",n),n},r.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},r.p="/",r(r.s=13)}([function(e,n){e.exports=require("lodash.get")},function(e,n){e.exports=require("mysql")},function(e,n){e.exports=require("graphql")},function(e,n){e.exports=require("path")},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("axios")},function(e,n){e.exports=require("uuid")},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("helmet")},function(e,n){e.exports=require("cookie-parser")},function(e,n){e.exports=require("cookie-session")},function(e,n){e.exports=require("csurf")},function(e,n){e.exports=require("express-graphql")},function(e,n,r){e.exports=r(15)},function(e,n){e.exports=require("regenerator-runtime/runtime")},function(e,n,r){"use strict";r.r(n);r(14);var t=r(7),o=r.n(t),a=r(8),u=r.n(a),s=r(4),i=r.n(s),c=r(9),p=r.n(c),l=r(10),d=r.n(l),f=process.env,m=f.SERVER_PORT,h=f.SESSION_SECRET,E=f.CSRF_EXCEPTION,b=f.FB_APP_KEY,k=f.FB_APP_SECRET,y=f.FB_REDIRECT_URL,g="https://graph.facebook.com/v3.3",v=r(0),R=r.n(v),S=r(5),_=r.n(S),O=function(e){return"https://www.facebook.com/v3.3/dialog/oauth?client_id=".concat(b,"&response_type=code&state=").concat(e,"&redirect_uri=").concat(y)};function x(e,n,r,t,o,a,u){try{var s=e[a](u),i=s.value}catch(e){return void r(e)}s.done?n(i):Promise.resolve(i).then(t,o)}var L=function(e,n){var r=n.code;return{client_id:b,client_secret:k,code:r,redirect_uri:y}},I=function(){var e,n=(e=regeneratorRuntime.mark(function e(n,r){var t,o,a,u,s,i,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=R()(n,"query.code",null),o=R()(n,"query.state",null),a=R()(n,"params.oauth",null),u=R()(n,"session.app.oauthState",null),!t||!o||o!==u){e.next=14;break}return console.log("redirected by ".concat(a," auth...")),s=L(0,n.query),e.next=9,p=s,_()({baseURL:g,method:"get",url:"/oauth/access_token",params:p});case 9:i=e.sent,(c=i.data).access_token?n.session.app={oauth:a,isAuth:!0,tokenInfo:c}:n.session.app={isAuth:!1,authError:"get token failed."},e.next=16;break;case 14:console.log("inconsistant session, error msg in session"),n.session.app={isAuth:!1,authError:"Sorry, something error, please try again."};case 16:r.redirect("/");case 17:case"end":return e.stop()}var p},e)}),function(){var n=this,r=arguments;return new Promise(function(t,o){var a=e.apply(n,r);function u(e){x(a,t,o,u,s,"next",e)}function s(e){x(a,t,o,u,s,"throw",e)}u(void 0)})});return function(e,r){return n.apply(this,arguments)}}(),T=r(3),C=r.n(T),w=process.env.PWD,A=r(11),P=r.n(A)()(),N=function(){for(var e=void 0,n=arguments.length,r=new Array(n),t=0;t<n;t++)r[t]=arguments[t];R()(r[0],"body._csrf",null)===E?(console.log("csrf exception"),r[2]()):P.apply(e,r)},j=r(12),M=r.n(j),q=r(6),F=r.n(q),U=r(1),D=r.n(U),W=r(2),Q=process.env,H=Q.SQL_HOST,B=Q.SQL_PORT,G=Q.SQL_USERNAME,V=Q.SQL_PASSWORD,Y=Q.SQL_DATABASE,K=D.a.createPool({connectionLimit:4,multipleStatements:!1,host:H,port:B,user:G,password:V,database:Y}),J=function(e){return new Promise(function(n,r){K.query(e,function(e,t){e?(console.error(e),r(e)):n(t)})})},X=function(e,n){return Boolean(R()(e,"session.app.isAuth",!1)&&(n||R()(e,"session.app.dbInfo.id",null)))},z=function(e){var n=R()(e,"session.app.tokenInfo.access_token",null);return"string"==typeof n&&n.length>0},Z=function(e){return X(e)&&R()(e,"session.app.dbInfo.isAdmin",!1)};function $(e,n,r,t,o,a,u){try{var s=e[a](u),i=s.value}catch(e){return void r(e)}s.done?n(i):Promise.resolve(i).then(t,o)}function ee(e){return function(){var n=this,r=arguments;return new Promise(function(t,o){var a=e.apply(n,r);function u(e){$(a,t,o,u,s,"next",e)}function s(e){$(a,t,o,u,s,"throw",e)}u(void 0)})}}var ne,re,te,oe,ae,ue={auth:(ae=ee(regeneratorRuntime.mark(function e(n,r){var t,o,a,u,s,i,c,p,l,d,f,m,h,E,b,k,y,v;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!X(r,!0)||!z(r)){e.next=37;break}return t=R()(r,"session.app.tokenInfo.access_token",null),o={access_token:t,fields:"id,name,picture"},e.prev=3,e.next=6,n=o,_()({baseURL:g,method:"get",url:"/me",params:n});case 6:return a=e.sent,u=a.data,s=u.name,i=u.id,c="SELECT * FROM colorpk_user WHERE oauth = 'fb' AND oauthid = ".concat(Object(U.escape)(i)),e.next=12,J(c);case 12:if(1!==(p=e.sent).length){e.next=23;break}return l=p[0],d=l.isadmin,f=l.id,r.session.app.dbInfo={id:f,name:s,isAdmin:d||!1},m="SELECT color_id FROM colorpk_userlike WHERE user_id= ".concat(Object(U.escape)(f)),e.next=19,J(m);case 19:return h=e.sent,E="UPDATE colorpk_user SET lastlogin=NOW() WHERE id=".concat(Object(U.escape)(f)),J(E),e.abrupt("return",{__typename:"User",id:f,name:s,isadmin:d,img:R()(u,"picture.data.url",null),likes:h.map(function(e){return e.color_id})});case 23:return b="INSERT INTO colorpk_user (oauth, name, oauthid, lastlogin) VALUES ('fb', '".concat(s,"', '").concat(i,"', NOW())"),e.next=26,J(b);case 26:return k=e.sent,y=k.insertId,r.session.app.dbInfo={id:y,name:s,isAdmin:!1},e.abrupt("return",{user:{__typename:"User",id:y,name:s,isadmin:!1,img:R()(u,"picture.data.url",null),likes:[]}});case 32:return e.prev=32,e.t0=e.catch(3),e.abrupt("return",new W.GraphQLError(e.t0.toString()));case 35:e.next=40;break;case 37:return v=F.a.v1(),r.session.app={oauthState:v},e.abrupt("return",{__typename:"AuthFailResponse",url:O(v),error:R()(r,"session.app.authError",null),status:0});case 40:case"end":return e.stop()}var n},e,null,[[3,32]])})),function(e,n){return ae.apply(this,arguments)}),color:(oe=ee(regeneratorRuntime.mark(function e(n,r){var t,o,a,u,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=n.category,X(r)||!(["LIKES","PROFILE"].indexOf(t)>-1)){e.next=3;break}return e.abrupt("return",new W.GraphQLError("color error: no user defined"));case 3:if(Z(r)||"ANONYMOUS"!==t){e.next=5;break}return e.abrupt("return",new W.GraphQLError("color error: no admin access"));case 5:o=R()(r,"session.app.dbInfo.id",null),a=Object(U.escape)(o),u=null,e.t0=t,e.next="PUBLIC"===e.t0?11:"LIKES"===e.t0?13:"PROFILE"===e.t0?15:"ANONYMOUS"===e.t0?17:19;break;case 11:return u="SELECT a.* FROM colorpk_color a WHERE a.display=0 ORDER BY `id` DESC",e.abrupt("break",20);case 13:return u="SELECT a.* FROM colorpk_color a\n          INNER JOIN \n          (SELECT color_id FROM colorpk_userlike WHERE user_id = ".concat(a,") b\n          ON id = b.color_id"),e.abrupt("break",20);case 15:return u="SELECT a.*, false as `liked` FROM colorpk_color a WHERE userid = ".concat(a," "),e.abrupt("break",20);case 17:return u="SELECT * FROM colorpk_color a WHERE a.display = 1",e.abrupt("break",20);case 19:return e.abrupt("break",20);case 20:return e.prev=20,e.next=23,J(u);case 23:return s=e.sent,e.abrupt("return",s.map(function(e){return{id:e.id,like:e.like,color:e.color,userid:e.userid,username:e.username,createdate:e.createdate}}));case 27:return e.prev=27,e.t1=e.catch(20),e.abrupt("return",new W.GraphQLError(e.t1.toString()));case 30:case"end":return e.stop()}},e,null,[[20,27]])})),function(e,n){return oe.apply(this,arguments)}),likeColor:(te=ee(regeneratorRuntime.mark(function e(n,r){var t,o,a,u,s,i,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.input,o=t.id,a=t.willLike,e.prev=1,X(r)&&(u=R()(r,"session.app.dbInfo.id",null),s=a?"INSERT INTO colorpk_userlike (user_id, color_id) VALUES (".concat(Object(U.escape)(u),", ").concat(Object(U.escape)(o),")"):"DELETE FROM colorpk_userlike WHERE user_id= ".concat(u," AND color_id = ").concat(Object(U.escape)(o)),J(s)),i="UPDATE colorpk_color SET `like` = `like` ".concat(a?"+":"-","  1 WHERE id = ").concat(Object(U.escape)(o)),e.next=6,J(i);case 6:return c=e.sent,e.abrupt("return",{status:1===c.affectedRows?0:1});case 10:return e.prev=10,e.t0=e.catch(1),e.abrupt("return",new W.GraphQLError(e.t0.toString()));case 13:case"end":return e.stop()}},e,null,[[1,10]])})),function(e,n){return te.apply(this,arguments)}),createColor:(re=ee(regeneratorRuntime.mark(function e(n,r){var t,o,a,u,s,i,c,p,l,d;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=n.input.color,o=X(r),a=R()(r,"session.app.dbInfo.name",null),u=R()(r,"session.app.dbInfo.id",null),s=o&&a?"'".concat(a,"'"):"NULL",i=o&&u?"".concat(u):"NULL",c="NULL"===i?1:0,p=(10*Math.random()).toFixed(),27!==t.length){e.next=22;break}return l="INSERT INTO colorpk_color (`like`, color, userid, username, colortype, display, createdate) VALUES (".concat(p,", '").concat(t,"', ").concat(i,", ").concat(s,", NULL, ").concat(c,", NOW())"),e.prev=10,e.next=13,J(l);case 13:return d=e.sent,e.abrupt("return",{status:0,data:d.insertId});case 17:return e.prev=17,e.t0=e.catch(10),e.abrupt("return",new W.GraphQLError(e.t0.toString()));case 20:e.next=23;break;case 22:return e.abrupt("return",new W.GraphQLError("create error: invalid color input"));case 23:case"end":return e.stop()}},e,null,[[10,17]])})),function(e,n){return re.apply(this,arguments)}),adjudicateColor:(ne=ee(regeneratorRuntime.mark(function e(n,r){var t,o,a,u,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(Z(r)){e.next=2;break}return e.abrupt("return",new W.GraphQLError("adjudicate error: no admin access"));case 2:return t=n.input,o=t.id,a=t.willLike,u=a?"UPDATE colorpk_color SET `display` = 0 WHERE id = ".concat(Object(U.escape)(o)):"DELETE FROM colorpk_color WHERE id = '".concat(o,"'"),e.prev=4,e.next=7,J(u);case 7:return s=e.sent,e.abrupt("return",{status:1===s.affectedRows?0:1});case 11:return e.prev=11,e.t0=e.catch(4),e.abrupt("return",new W.GraphQLError(e.t0.toString()));case 14:case"end":return e.stop()}},e,null,[[4,11]])})),function(e,n){return ne.apply(this,arguments)}),logoff:function(e,n){var r=R()(n,"session.app.dbInfo.name","(unknow)");console.log("logoff ".concat(r,", delete session")),delete n.session.app;var t=F.a.v1();return n.session.app={oauthState:t},{url:O(t)}}},se=Object(W.buildSchema)("\n  enum ColorCategory {\n    PUBLIC\n    LIKES\n    PROFILE\n    ANONYMOUS\n  }\n\n  interface MutationResponse {\n    status: Int!\n  }\n\n  type Color {\n    id: ID!\n    like: Int!\n    color: String!\n    userid: Int\n    username: String\n    createdate: String\n  }\n\n  type User {\n    id: ID!\n    img: String\n    isadmin: Boolean\n    name: String\n    likes: [Int!]\n  }\n\n  input LikeColorInputType {\n    id: ID!\n    willLike: Boolean!\n  }\n  \n  input CreateColorInputType {\n    color: String!\n  }\n\n  type LikeColorOutputType implements MutationResponse {\n    status: Int!\n  }\n\n  type AdjudicateColorOutputType implements MutationResponse {\n    status: Int!\n  }\n\n  type CreateColorOutputType implements MutationResponse {\n    status: Int!\n    data: ID!\n  }\n\n  type AuthFailResponse implements MutationResponse {\n    status: Int!\n    url: String!\n    error: String\n  }\n\n  union AuthOutputType = User | AuthFailResponse\n\n  type Mutation {\n    likeColor(input: LikeColorInputType!): LikeColorOutputType\n    createColor(input: CreateColorInputType!): CreateColorOutputType\n    adjudicateColor(input: LikeColorInputType!): AdjudicateColorOutputType\n    logoff: AuthFailResponse\n  }\n  \n  type Query {\n    color(category: ColorCategory!): [Color]\n    auth: AuthOutputType\n  }\n\n  schema {\n    query: Query\n    mutation: Mutation\n  } \n"),ie=M()({schema:se,rootValue:ue,graphiql:!1,pretty:!1}),ce=["","portfolio","popular","latest","like","color","new","adminpanel"],pe=process.env.PWD,le=o()();le.set("x-powered-by",!1),le.use(u()()),le.use(i.a.json()),le.use(i.a.urlencoded({extended:!1})),le.use(p()()),le.use(d()({name:"session",keys:[h],domain:"react.colorpk.com",maxAge:2592e5,httpOnly:!0})),le.use(N),le.use("/graphql",ie),le.get("/auth/:oauth",I),le.get("/*",function(e,n,r){var t=e.url.split("/");if(ce.includes(t[1])){n.cookie("_csrf",e.csrfToken());var o=C.a.join(pe,"./".concat("dist","/public/index.html"));n.sendFile(o)}else r(404)}),le.use(function(e,n,r,t){404===e?(console.error("=====  resource(".concat(n.url,") not found  =====")),r.status(404).sendFile(C.a.resolve(w,"./".concat("dist","/public/404.html")))):(console.error("=====  Internal Error  ====="),console.log(e.toString()),r.status(500).json(500))}),le.listen(m,"localhost",function(){console.log("app(mode: ".concat("production",") is running: http://").concat("localhost",":").concat(m))}).timeout=5e3}]);